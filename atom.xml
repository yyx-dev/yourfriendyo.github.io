<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://yourfriendyo.github.io/</id>
    <title>yourfriendyo</title>
    <updated>2023-11-09T07:21:34.281Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://yourfriendyo.github.io/"/>
    <link rel="self" href="https://yourfriendyo.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://yourfriendyo.github.io/images/avatar.png</logo>
    <icon>https://yourfriendyo.github.io/favicon.ico</icon>
    <rights>All rights reserved 2023, yourfriendyo</rights>
    <entry>
        <title type="html"><![CDATA[åŒæ­¥å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ]]></title>
        <id>https://yourfriendyo.github.io/post/tong-bu-yi-bu-ri-zhi-xi-tong/</id>
        <link href="https://yourfriendyo.github.io/post/tong-bu-yi-bu-ri-zhi-xi-tong/">
        </link>
        <updated>2023-11-09T07:19:11.000Z</updated>
        <content type="html"><![CDATA[<h1 id="åŒæ­¥å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ">åŒæ­¥å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ</h1>
<h2 id="1-é¡¹ç›®ä»‹ç»">1. é¡¹ç›®ä»‹ç»</h2>
<p><a href="https://gitee.com/yourfriendyo/logger">é¡¹ç›®é“¾æ¥</a></p>
<p>æœ¬é¡¹ç›®æ˜¯æ’ä»¶å¼çš„åŒæ­¥å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿï¼Œä¸ä»…èƒ½è®©ç”¨æˆ·ç®€ä¾¿çš„è¾“å‡ºæ—¥å¿—ï¼Œä¹Ÿæ”¯æŒå¤šç§åŠŸèƒ½ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ”¯æŒå¤šçº§åˆ«æ—¥å¿—æ¶ˆæ¯</li>
<li>æ”¯æŒåŒæ­¥æ—¥å¿—å’Œå¼‚æ­¥æ—¥å¿—</li>
<li>æ”¯æŒæ—¥å¿—å¤šè½åœ°æ–¹å‘ï¼šåˆ°æ§åˆ¶å°ã€æ–‡ä»¶ä»¥åŠæ»šåŠ¨æ–‡ä»¶ä¸­ï¼ˆè½åœ°æ–¹å‘æ”¯æŒæ‹“å±•ï¼‰</li>
<li>æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘å†™å…¥æ—¥å¿—</li>
</ol>
<p>å¼€å‘ç¯å¢ƒï¼šcentos7ã€vimã€g++/gdbã€Makefileï¼Œä¸ä¾èµ–å…¶ä»–åº“ã€‚</p>
<h4 id="å¼‚æ­¥æ—¥å¿—">å¼‚æ­¥æ—¥å¿—</h4>
<p>åŒæ­¥æ—¥å¿—æŒ‡ä¸šåŠ¡çº¿ç¨‹ä¹Ÿè´Ÿè´£æ—¥å¿—è¾“å‡ºï¼Œä½†ä¼šå½±å“ä¸šåŠ¡æ€§èƒ½ã€‚</p>
<p>å¼‚æ­¥æ—¥å¿—çš„å…·ä½“åšæ³•æ˜¯ä¸šåŠ¡çº¿ç¨‹å°†æ—¥å¿—æ”¾å…¥ç¼“å†²åŒºå†…ï¼Œæ—¥å¿—çº¿ç¨‹ä»ä¸­æå–æ—¥å¿—è¿›è¡Œè¾“å‡ºï¼Œæ•…ä¸ä¼šè€½è¯¯ä¸šåŠ¡çº¿ç¨‹çš„è¿è¡Œã€‚</p>
<h3 id="æŠ€æœ¯é‡ç‚¹">æŠ€æœ¯é‡ç‚¹</h3>
<ul>
<li>ç±»å±‚æ¬¡è®¾è®¡</li>
<li>å¤šçº¿ç¨‹ã€æ™ºèƒ½æŒ‡é’ˆã€å³å€¼å¼•ç”¨</li>
<li>åŒç¼“å†²åŒº</li>
<li>ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹</li>
<li>å¤šè®¾è®¡æ¨¡å¼ï¼šå•ä¾‹ã€å·¥å‚ã€å»ºé€ è€…</li>
</ul>
<p>Â </p>
<h2 id="2-æ¡†æ¶è®¾è®¡">2. æ¡†æ¶è®¾è®¡</h2>
<p>æ—¥å¿—ç³»ç»Ÿçš„ä½œç”¨å°±æ˜¯å°†ä¸€æ¡æ¶ˆæ¯æ ¼å¼åŒ–æˆæŒ‡å®šæ ¼å¼çš„å­—ç¬¦ä¸²å¹¶å†™å…¥åˆ°æŒ‡å®šä½ç½®ã€‚æ‰€ä»¥å…±è®¾è®¡å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š</p>
<ul>
<li>æ—¥å¿—ç­‰çº§é™åˆ¶æ¨¡å—ï¼šæ”¯æŒé™åˆ¶æ—¥å¿—ç­‰çº§å¼çš„è¾“å‡ºã€‚</li>
<li>æ—¥å¿—æ¶ˆæ¯æ¨¡å—ï¼šå°è£…ä¸€æ¡æ—¥å¿—æ‰€éœ€çš„å„ç§è¦ç´ ï¼Œå¦‚ï¼šæ—¶é—´ã€çº¿ç¨‹IDã€æ–‡ä»¶åã€è¡Œå·ã€æ—¥å¿—ç­‰çº§ã€æ¶ˆæ¯ä¸»ä½“ç­‰</li>
<li>æ—¥å¿—æ ¼å¼åŒ–æ¨¡å—ï¼šå°†æ—¥å¿—çš„å„ç§è¦ç´ ä»¥åŠæ¶ˆæ¯ä¸»ä½“æ ¼å¼åŒ–æˆä¸€ä¸ªå­—ç¬¦ä¸²</li>
<li>æ—¥å¿—è½åœ°æ¨¡å—ï¼šæ”¯æŒå¤šç§è½åœ°ä½ç½®ï¼Œå¹¶æ”¯æŒæ‹“å±•ã€‚</li>
<li>æ—¥å¿—å™¨æ¨¡å—ï¼šå¯¹ä¸Šé¢å¤šä¸ªæ¨¡å—è¿›è¡Œå¯¹è±¡ç»„åˆã€‚åˆ†ä¸ºåŒæ­¥æ—¥å¿—å™¨æ¨¡å—å’Œå¼‚æ­¥æ—¥å¿—å™¨æ¨¡å—ã€‚</li>
<li>å¼‚æ­¥è¾“å‡ºçº¿ç¨‹æ¨¡å—ï¼šè´Ÿè´£å¼‚æ­¥æ—¥å¿—çš„å®é™…è½åœ°è¾“å‡ºã€‚</li>
<li>æ—¥å¿—å™¨ç®¡ç†æ¨¡å—ï¼šä»¥æ—¥å¿—å™¨å™¨ä¸ºå•ä½ï¼Œæ”¯æŒå¤šæ—¥å¿—å™¨è¾“å‡ºã€‚å¯¹æ—¥å¿—å™¨è¿›è¡Œå…¨å±€çš„ç®¡ç†ï¼Œä»¥ä¾¿äºèƒ½åœ¨é¡¹ç›®ä¸­ä»»ä½•ä½ç½®è·å–æŒ‡å®šæ—¥å¿—å™¨è¿›è¡Œè¾“å‡ºã€‚</li>
</ul>
<img src="https://img.gejiba.com/images/69761d87f850184715f9b0f69f3a59e3.png" style="zoom:38%;" />
<h2 id="3-ä»£ç è®¾è®¡">3. ä»£ç è®¾è®¡</h2>
<h3 id="31-æ—¥å¿—ç­‰çº§ç±»">3.1 æ—¥å¿—ç­‰çº§ç±»</h3>
<ul>
<li>å®šä¹‰æ‰€æœ‰æ—¥å¿—ç­‰çº§</li>
<li>å®šä¹‰æ¥å£ï¼Œå°†å¯¹åº”ç­‰çº§çš„æšä¸¾å˜é‡è½¬åŒ–ä¸ºå­—ç¬¦ä¸²</li>
</ul>
<p>æ—¥å¿—å…±åˆ†7ä¸ªç­‰çº§ï¼Œé¡¹ç›®ä¼šå®šä¹‰ä¸€ä¸ªé»˜è®¤çš„è¾“å‡ºç­‰çº§ï¼Œåªæœ‰å½“æ—¥å¿—çš„ç­‰çº§å¤§äºç­‰äºé»˜è®¤çš„ç­‰çº§æ—¶æ‰è¿›è¡Œè¾“å‡ºã€‚</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ON</code></td>
<td>å¼€å¯æ‰€æœ‰æ—¥å¿—</td>
</tr>
<tr>
<td><code>DEBUG</code></td>
<td>è°ƒè¯•çº§åˆ«æ—¥å¿—</td>
</tr>
<tr>
<td><code>INFO</code></td>
<td>ç”¨æˆ·çº§æç¤ºä¿¡æ¯</td>
</tr>
<tr>
<td><code>WARN</code></td>
<td>è­¦å‘Šä¿¡æ¯</td>
</tr>
<tr>
<td><code>ERROR</code></td>
<td>ç¨‹åºé”™è¯¯ä¿¡æ¯</td>
</tr>
<tr>
<td><code>FATAL</code></td>
<td>ç¨‹åºè‡´å‘½é”™è¯¯ä¿¡æ¯</td>
</tr>
<tr>
<td><code>OFF</code></td>
<td>å…³é—­æ‰€æœ‰æ—¥å¿—</td>
</tr>
</tbody>
</table>
<pre><code class="language-cpp">struct log_level {
    enum value {
        DEBUG,
        INFO,
        WARN,
        ERROR,
        FATAL,
        OFF,
    };
    const char* to_string(value level) {
        switch (level) {
        case value::DEBUG: return &quot;DEBUG&quot;; 
        //...
        }
    }
};
</code></pre>
<h3 id="32-æ—¥å¿—æ¶ˆæ¯ç±»">3.2 æ—¥å¿—æ¶ˆæ¯ç±»</h3>
<p>æ—¥å¿—æ¶ˆæ¯ç±»è´Ÿè´£ï¼Œåœ¨ä¸­é—´æ—¶åˆ»ï¼Œå­˜å‚¨ä¸€æ¡æ—¥å¿—æ¶ˆæ¯æ‰€éœ€è¦çš„å„é¡¹è¦ç´ ï¼šæ—¶é—´ã€æ—¥å¿—ç­‰çº§ã€æºæ–‡ä»¶åã€æºä»£ç è¡Œå·ã€çº¿ç¨‹IDã€ä¿¡æ¯ä¸»ä½“å’Œæ—¥å¿—å™¨åç§°ã€‚</p>
<pre><code class="language-cpp">struct log_msg
{
    size_t _generate_time;   // æ—¥å¿—çš„äº§ç”Ÿæ—¶é—´
    log_level::value _level; // æ—¥å¿—ç­‰çº§
    std::thread::id _tid;    // çº¿ç¨‹ID
    size_t _line;            // è¡Œå·
    std::string _file;       // æ–‡ä»¶å
    std::string _logger;     // æ—¥å¿—å™¨åç§°
    std::string _payload;    // æ¶ˆæ¯ä¸»ä½“

    log_msg(log_level::value level, size_t line,
            const std::string&amp;&amp; file, const std::string&amp;&amp; logger, const std::string&amp;&amp; msg);
};
</code></pre>
<h3 id="33-æ—¥å¿—æ ¼å¼åŒ–ç±»">3.3 æ—¥å¿—æ ¼å¼åŒ–ç±»</h3>
<h4 id="åŠŸèƒ½">åŠŸèƒ½</h4>
<p>è¯¥ç±»è´Ÿè´£å¯¹æ—¥å¿—æ¶ˆæ¯è¿›è¡Œæ ¼å¼åŒ–ç»„ç»‡ï¼Œç»„ç»‡æˆæŒ‡å®šæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œç„¶åå°†å…¶è¿”å›ã€‚</p>
<table>
<thead>
<tr>
<th>æ ¼å¼æ§åˆ¶å­—ç¬¦</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>%d{%H:%M:%S}</code></td>
<td>è¡¨ç¤ºæ—¥æœŸæ—¶é—´ï¼Œå¤§æ‹¬å·ä¸­å†…å®¹è¡¨ç¤ºæ—¥æœŸæ—¶é—´çš„æ ¼å¼</td>
</tr>
<tr>
<td><code>%T</code></td>
<td>è¡¨ç¤ºåˆ¶è¡¨ç¬¦ç¼©è¿›</td>
</tr>
<tr>
<td><code>%t</code></td>
<td>è¡¨ç¤ºçº¿ç¨‹ID</td>
</tr>
<tr>
<td><code>%p</code></td>
<td>è¡¨ç¤ºæ—¥å¿—ç­‰çº§</td>
</tr>
<tr>
<td><code>%c</code></td>
<td>è¡¨ç¤ºæ—¥å¿—å™¨åç§°ï¼Œä¸åŒå¼€å‘ç»„å¯ä»¥ä½¿ç”¨è‡ªå·±çš„æ—¥å¿—å™¨è¿›è¡Œè¾“å‡ºï¼Œäº’ä¸å½±å“</td>
</tr>
<tr>
<td><code>%f</code></td>
<td>è¡¨ç¤ºæºç æ–‡ä»¶å</td>
</tr>
<tr>
<td><code>%l</code></td>
<td>è¡¨ç¤ºæ—¥å¿—è¾“å‡ºæ—¶çš„æºç è¡Œå·</td>
</tr>
<tr>
<td><code>%m</code></td>
<td>è¡¨ç¤ºæ—¥å¿—æ¶ˆæ¯ä¸»ä½“</td>
</tr>
<tr>
<td><code>%n</code></td>
<td>è¡¨ç¤ºæ¢è¡Œ</td>
</tr>
</tbody>
</table>
<p>ä¼ å…¥åŒ…å«æ§åˆ¶å­—ç¬¦çš„æ ¼å¼æ§åˆ¶ä¸²ï¼ŒæŒ‰å…¶è¦æ±‚è¾“å‡ºæ ¼å¼åŒ–æ—¥å¿—ã€‚</p>
<pre><code class="language-txt">[%d{%H:%M:%S}][%p][%t][%c][%f:%l]%T%m%n
[12:09:33][INFO][12649422][root][main.cc:38]	socket created\n
</code></pre>
<h4 id="è®¾è®¡">è®¾è®¡</h4>
<p>æŠ½è±¡å‡ºä¸€ä¸ªæ ¼å¼åŒ–å­é¡¹çš„åŸºç±»ï¼Œå†æ´¾ç”Ÿå‡ºä¸åŒæ ¼å¼æ§åˆ¶é¡¹çš„å­ç±»ï¼Œå¦‚ä¸»ä½“æ¶ˆæ¯å­é¡¹ã€æ—¶é—´å­é¡¹ã€æ–‡ä»¶åå­é¡¹ç­‰ç­‰ï¼Œä»¥åŠå…¶ä»–å…ƒç´ å­é¡¹ã€‚</p>
<pre><code class="language-cpp">// æŠ½è±¡æ ¼å¼åŒ–å­é¡¹åŸºç±»
struct format_item {
    using ptr = std::shared_ptr&lt;format_item&gt;;
    virtual void format(std::ostream&amp; out, log::log_msg&amp; msg) = 0;
};

// æ ¼å¼åŒ–å­é¡¹å­ç±» -- æ¶ˆæ¯ã€ç­‰çº§ã€æ—¶é—´ã€æ–‡ä»¶åã€è¡Œå·ã€çº¿ç¨‹IDã€æ—¥å¿—å™¨åã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œã€å…¶ä»–
struct payload_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct level_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct time_format_item : public format_item {
    time_format_item(const std::string&amp; fmt = &quot;%H:%M:%S&quot;);
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override; 
    std::string _time_fmt_str; // %H:%M:%S
};
struct file_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct line_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct thread_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct logger_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct tab_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct nline_format_item : public format_item {
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
};
struct other_format_item : public format_item {
    other_format_item(const std::string&amp; s);
    void format(std::ostream&amp; out, log::log_msg&amp; msg) override;
    std::string _s;
};
</code></pre>
<p>æ ¼å¼åŒ–å™¨ç±»ä¸­æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€æ˜¯æ ¼å¼åŒ–è§„åˆ™å­—ç¬¦ä¸²ï¼Œæ§åˆ¶æ ¼å¼åŒ–çš„è¦æ±‚ã€‚äºŒæ˜¯æ ¼å¼åŒ–å­é¡¹çˆ¶ç±»çš„æŒ‡é’ˆæ•°ç»„ï¼Œä¿å­˜å„ä¸ªæ ¼å¼åŒ–å­é¡¹çš„å­ç±»å¯¹è±¡ã€‚</p>
<p>åœ¨æ ¼å¼åŒ–è¾“å‡ºçš„æ—¶å€™ï¼Œä¾æ¬¡è·å–æ•°ç»„å…ƒç´ å³å­ç±»å¯¹è±¡ã€‚ç»Ÿä¸€è°ƒç”¨formatæ–¹æ³•å°†å†…å®¹å¯¼å…¥æµä¸­ï¼Œå†è½¬æ¢æˆå­—ç¬¦ä¸²è¾“å‡ºã€‚</p>
<pre><code class="language-cpp">class formatter
{
public:
    formatter(const std::string&amp; pattern = &quot;[%d{%H:%M:%S}][%p][%t][%c][%f:%l]%T%m%n&quot;);
    // æ ¼å¼åŒ–msg
    void format(std::ostream&amp; out, log_msg&amp; msg);
    std::string format(log_msg&amp; msg);
    // è§£ææ ¼å¼åŒ–å­—ç¬¦ä¸² - ä¸æ˜¯%å°±å‘åéå†ï¼Œç›´åˆ°é‡åˆ°%ï¼Œå‰é¢æ˜¯ä¸€ä¸ªåŸå§‹å­—ç¬¦ä¸²å­é¡¹ï¼Œåé¢æ˜¯ä¸€ä¸ªæ§åˆ¶å­—ç¬¦
    bool parsePattern();
private:
    // æ ¹æ®æ ¼å¼æ§åˆ¶å­—ç¬¦åˆ›å»ºæ ¼å¼åŒ–å­é¡¹
    void add_item(const std::string&amp; key, const std::string&amp; val);
private:
    std::string _pattern; // æ ¼å¼åŒ–è§„åˆ™å­—ç¬¦ä¸²
    std::vector&lt;format_item::ptr&gt; _items;
};
</code></pre>
<h3 id="34-æ—¥å¿—è½åœ°ç±»">3.4 æ—¥å¿—è½åœ°ç±»</h3>
<h4 id="åŠŸèƒ½-2">åŠŸèƒ½</h4>
<p>æ—¥å¿—è½åœ°ç±»æ˜¯è´Ÿè´£å°†å·²æ ¼å¼åŒ–å¥½çš„æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šä½ç½®ï¼Œå¹¶æ”¯æŒæ‰©å±•å°†æ—¥å¿—è½åœ°åˆ°ä¸åŒä½ç½®ã€‚</p>
<p>ä¸€èˆ¬ä½ç½®æœ‰æ ‡å‡†è¾“å‡ºã€æŒ‡å®šæ–‡ä»¶ã€æ»šåŠ¨æ–‡ä»¶ï¼ˆæ–‡ä»¶æŒ‰ç…§æ—¶é—´æˆ–å¤§å°è¿›è¡Œæ»šåŠ¨åˆ‡æ¢ï¼‰å’Œè‡ªå®šä¹‰è½åœ°æ–¹å‘ã€‚</p>
<h4 id="è®¾è®¡-2">è®¾è®¡</h4>
<p>æŠ½è±¡å‡ºè½åœ°æ¨¡å—çš„åŸºç±»ï¼Œä¸åŒçš„è½åœ°æ–¹å‘ä»åŸºç±»æ´¾ç”Ÿã€‚ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼åˆ›å»ºä¸åŒçš„è½åœ°å™¨ã€‚</p>
<pre><code class="language-cpp">class log_sink {
public:
    using ptr = std::shared_ptr&lt;log_sink&gt;;
    log_sink() {}
    virtual ~log_sink() {}
    virtual void log(std::string&amp; data, size_t len) = 0;
};

// è½åœ°æ–¹å‘ï¼šæ ‡å‡†è¾“å‡º
class stdout_sink : public log_sink {
public:
    void log(std::string&amp; data) override;
};

// è½åœ°æ–¹å‘ï¼šæŒ‡å®šæ–‡ä»¶
class file_sink : public log_sink {
public:
    file_sink(const std::string&amp; path);
    void log(std::string&amp; data) override;
private:
    std::string _file;
    std::ofstream _ofs;
};

// è½åœ°æ–¹å‘ï¼šæ»šåŠ¨æ–‡ä»¶ï¼ˆæŒ‰å¤§å°æ»šåŠ¨ï¼‰
class rolling_sink : public log_sink
{
public:
    rolling_sink(const std::string&amp; base_name, size_t max_size);
    void log(std::string&amp; data) override;
private:
    void rolling();
private:
    std::string _base_name; // åŸºç¡€æ–‡ä»¶å ./logs/&lt;base&gt;-
    std::ofstream _ofs;
    size_t _max_size;
    size_t _cur_size;
};

// æ—¥å¿—è½åœ°å™¨å·¥å‚
class sink_factory
{
public:
    template&lt;typename Sinker, typename... Args&gt;
    static log_sink::ptr create(Args&amp;&amp;... args);
};
</code></pre>
<h4 id="å¯æ‹“å±•">å¯æ‹“å±•</h4>
<p>æ‹“å±•å®é™…ä¸Šå°±æ˜¯ç¼–å†™<code>log_sink</code>çš„å­ç±»ï¼Œé‡å†™<code>void log(std::string&amp; data)</code>å‡½æ•°ã€‚</p>
<p>æ‹“å±•ä¸€ä¸ªä»¥æ—¶é—´ä¸ºæ»šåŠ¨æ¡ä»¶çš„æ—¥å¿—è½åœ°æ¨¡å—ï¼š</p>
<pre><code class="language-cpp">/* æ‹“å±•ä¸€ä¸ªä»¥æ—¶é—´ä¸ºæ»šåŠ¨æ¡ä»¶çš„æ—¥å¿—è½åœ°æ¨¡å— */
enum time_gap {
    SEC_GAP = 1,
    MIN_GAP = 60,
    HOU_GAP = 60 * 60,
    DAY_GAP = 24 * 60 * 60,
};

class roll_by_time : public log::log_sink {
public:
    roll_by_time(const std::string&amp; base_name, time_gap gap);
    void log(std::string&amp; data) override;
private:
    void rolling();
private:
    std::string _base_name; 
    std::ofstream _ofs;
    size_t _create_time;
    time_gap _gap; // æ—¶é—´é—´éš”
};
</code></pre>
<h4 id="æµ‹è¯•">æµ‹è¯•</h4>
<pre><code class="language-cpp">log_sink::ptr sinker1 = sink_factory::create&lt;log::stdout_sink&gt;();
log_sink::ptr sinker2 = sink_factory::create&lt;log::file_sink&gt;
(&quot;./log/test_file_sink.log&quot;);
log_sink::ptr sinker3 = sink_factory::create&lt;log::rolling_sink&gt;
(&quot;./log/test_rolling_sink&quot;, 1024 * 1024);

while (true)
{
    log_msg msg =  {log_level::DEBUG, __LINE__, __FILE__, &quot;root&quot;, &quot;Can i make it? &quot;};
    log::formatter fmtr;
    std::string log = fmtr.format(msg);

    sinker1-&gt;log(log);
    sinker3-&gt;log(log);
    sinker2-&gt;log(log);
    std::this_thread::sleep_for(std::chrono::microseconds(100));
}
</code></pre>
<h3 id="35-æ—¥å¿—å™¨æ¨¡å—">3.5 æ—¥å¿—å™¨æ¨¡å—</h3>
<h4 id="è®¾è®¡-3">è®¾è®¡</h4>
<p>å¯¹æ—¥å¿—ç­‰çº§æ¨¡å—ã€æ¶ˆæ¯æ¨¡å—ã€æ ¼å¼åŒ–æ¨¡å—å’Œè½åœ°æ¨¡å—è¿›è¡Œæ•´åˆï¼Œå‘å¤–æä¾›æ‰€æœ‰ç­‰çº§çš„æ—¥å¿—è¾“å‡ºæ¥å£ï¼Œåªæœ‰é«˜äºç­‰äºè¯¥ç­‰çº§çš„æ—¥å¿—æ‰èƒ½è¾“å‡ºã€‚</p>
<p>æ—¥å¿—å™¨ç±»çš„æˆå‘˜æœ‰ï¼šæ ¼å¼åŒ–å™¨ã€è½åœ°å™¨æ•°ç»„ï¼ˆæ”¯æŒå¤šè½åœ°è¾“å‡ºï¼‰ã€æ—¥å¿—ç­‰çº§é™åˆ¶å™¨ã€æ—¥å¿—å™¨åç§°ä»¥åŠçº¿ç¨‹äº’æ–¥é”ã€‚</p>
<h4 id="åŸºç±»å’ŒåŒæ­¥æ—¥å¿—å™¨">åŸºç±»å’ŒåŒæ­¥æ—¥å¿—å™¨</h4>
<p>å…ˆè®¾è®¡å‡ºæ—¥å¿—å™¨åŸºç±»ï¼Œå†æ´¾ç”Ÿå‡ºåŒæ­¥å’Œå¼‚æ­¥æ—¥å¿—å™¨ã€‚</p>
<p>æœ¬è´¨ä¸Šï¼ŒåŒæ­¥æ—¥å¿—å™¨å°±æ˜¯ç›´æ¥è½åœ°ï¼Œå¼‚æ­¥æ—¥å¿—å™¨å°±æ˜¯è½åœ°åˆ°å†…å­˜ï¼ŒäºŒè€…åªæœ‰è½åœ°æ–¹å‘çš„ä¸åŒï¼Œæ•…æˆ‘ä»¬å°†è½åœ°æ–¹å¼æŠ½è±¡å‡ºæ¥ï¼ŒäºŒè€…è°ƒç”¨å„è‡ªçš„è½åœ°æ–¹æ³•ã€‚</p>
<pre><code class="language-cpp">class logger
{
public:
    using ptr = std::shared_ptr&lt;logger&gt;;
public:
    // å¤šè½åœ°
    logger(const string&amp; name, log_level level, formatter::ptr&amp; fmtter, 
           vector&lt;log_sink::ptr&gt;&amp; sinkers);
    void debug(const string&amp; file, size_t line, const string&amp; fmt, ...);    	 
    void info(const string&amp; file, size_t line, const string&amp; fmt, ...);
    void warn(const string&amp; file, size_t line, const string&amp; fmt, ...);
  	void error(const string&amp; file, size_t line, const string&amp; fmt, ...);
    void fatal(const string&amp; file, size_t line, const string&amp; fmt, ...);
protected:
    virtual void log(const string&amp; data) = 0;
    std::string get_payload(const std::string&amp; fmt, va_list&amp; ap);
protected:    
    std::string _logger_name;
    std::atomic&lt;log_level::value&gt; _limit_level;
    formatter::ptr _formatter;
    std::vector&lt;log_sink::ptr&gt; _sinkers;
    std::mutex _mutex;
};
</code></pre>
<pre><code class="language-cpp">class sync_logger : public logger
{
public:
    sync_logger(const std::string&amp; name, log_level::value level, formatter::ptr&amp; fmtter, 
                std::vector&lt;log_sink::ptr&gt;&amp; sinkers);
protected:
    virtual void log(const std::string&amp; data);
};
</code></pre>
<h4 id="æ—¥å¿—å™¨å»ºé€ è€…">æ—¥å¿—å™¨å»ºé€ è€…</h4>
<pre><code class="language-cpp">log::formatter::ptr fmtter(new log::formatter);
log::log_sink::ptr sinker1 = log::sink_factory::create&lt;log::stdout_sink&gt;();
log::log_sink::ptr sinker2 = log::sink_factory::create&lt;log::file_sink&gt;
(&quot;./log/test_file_sink.log&quot;);
log::log_sink::ptr sinker3 = log::sink_factory::create&lt;log::rolling_sink&gt;
(&quot;./log/test_rolling_sink&quot;, log::memory_size::m1M);
std::vector&lt;log::log_sink::ptr&gt; sinkers = {sinker1, sinker2, sinker3};
log::sync_logger slogger(&quot;sync_logger&quot;, log::log_level::DEBUG, fmtter, sinkers);

slogger.debug(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger.info(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger.warn(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger.error(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger.fatal(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
</code></pre>
<p>åˆ›å»ºä¸€ä¸ªæ—¥å¿—å™¨æ¨¡å—éœ€è¦æå‰åˆ›å»ºæ ¼å¼åŒ–æ¨¡å—å’Œè½åœ°æ¨¡å—æ•°ç»„ï¼Œå¤ªè¿‡éº»çƒ¦ã€‚æ‰€ä»¥ä½¿ç”¨å»ºé€ è€…æ¨¡å¼æ¥å»ºé€ æ—¥å¿—å™¨ï¼Œç®€åŒ–ä½¿ç”¨å¤æ‚åº¦ã€‚</p>
<ol>
<li>é¦–å…ˆæˆ‘ä»¬æŠ½è±¡ä¸€ä¸ªæ—¥å¿—å™¨å»ºé€ è€…ç±»</li>
<li>ç„¶åæˆ‘ä»¬æ´¾ç”Ÿå‡ºå…·ä½“çš„å»ºé€ è€…ç±»</li>
<li>å†ä½¿ç”¨æŒ‡æŒ¥è€…ç±»æ„å»ºæ‰€éœ€è¦çš„æ‰€æœ‰ç»„ä»¶</li>
</ol>
<pre><code class="language-cpp">enum logger_type
{
    SYNC_LOGGER = 0,
    ASYNC_LOGGER,
};

class logger_builder
{
public:
    using ptr = std::shared_ptr&lt;logger_builder&gt;;
public:
    logger_builder();
    void build_logger_type(const logger_type type);
    void build_logger_name(const std::string name); 
    void build_logger_level(log_level::value level);
    void build_formatter(const std::string&amp; pattern);
    template&lt;typename SinkType, typename... Args&gt;
    void build_sinker(Args&amp;&amp;... args);
    virtual logger::ptr build() = 0;
protected:
    logger_type _logger_type;
    std::string _logger_name;
    log_level::value _base_level;
    formatter::ptr _formatter;
    std::vector&lt;log_sink::ptr&gt; _sinkers;
};

class local_logger_builder : public logger_builder {
public:
    logger::ptr build() override;
};

class logger_director {
public:
    using ptr = std::shared_ptr&lt;logger_director&gt;;
public:
    logger_director(logger_builder::ptr builder);
    void construct(logger_type type,
                   const std::string&amp; name, 
                   log_level::value level,
                   const std::string&amp; pattern = 
                   	   &quot;[%d{%F %H:%M:%S}][%p][%t][%c][%f:%l]%T%m%n&quot;);
    template&lt;typename SinkType, typename... Args&gt;
    void construct_sinker(Args&amp;&amp;... args);
private:
    logger_builder::ptr _builder;
};
</code></pre>
<h4 id="æµ‹è¯•-2">æµ‹è¯•</h4>
<pre><code class="language-cpp">log::logger_builder::ptr lbuiler(new log::local_logger_builder);
log::logger_director::ptr ldirector(new log::logger_director(lbuiler));

ldirector-&gt;construct(log::logger_type::SYNC_LOGGER, &quot;root_logger&quot;, DEBUG);
ldirector-&gt;construct_sinker&lt;log::stdout_sink&gt;();
ldirector-&gt;construct_sinker&lt;log::file_sink&gt;(&quot;./log/test_file_sink.log&quot;);
ldirector-&gt;construct_sinker&lt;log::rolling_sink&gt;(&quot;./log/test_rolling_sink&quot;,  m1M);
log::logger::ptr slogger = lbuiler-&gt;build();

slogger-&gt;debug(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger-&gt;info(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger-&gt;warn(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger-&gt;error(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
slogger-&gt;fatal(__FILE__, __LINE__, &quot;%d-%s&quot;, 33, &quot;can i make it ?&quot;);
</code></pre>
<h3 id="36-å¼‚æ­¥æ—¥å¿—æ¨¡å—">3.6 å¼‚æ­¥æ—¥å¿—æ¨¡å—</h3>
<h4 id="è®¾è®¡-4">è®¾è®¡</h4>
<p>å¼‚æ­¥æ—¥å¿—å™¨ï¼Œç›®çš„æ˜¯é˜²æ­¢æ—¥å¿—å†™å…¥å‘ç”Ÿé˜»å¡è€Œè€½è¯¯ä¸šåŠ¡çº¿ç¨‹çš„è¿è¡Œã€‚æ‰€ä»¥ä¸šåŠ¡çº¿ç¨‹åªéœ€å°†æ—¥å¿—å†…å®¹æ”¾å…¥ç¼“å†²åŒºä¸­ï¼Œæœ‰å¼‚æ­¥çº¿ç¨‹å®ç°è½åœ°ã€‚</p>
<img src="https://img.gejiba.com/images/2c020e0a4443748e638d1b5791246799.png" style="zoom: 45%;" />
<p>ä¸ºé¿å…é”é™ä½æ•ˆç‡ï¼Œæˆ‘ä»¬ä½¿ç”¨åŒç¼“å†²åŒºç­–ç•¥ã€‚</p>
<ul>
<li>å½“æ¶ˆè´¹ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œå°±å¯ä»¥è¿›è¡Œäº¤æ¢ã€‚è¿™æ ·å¯ä»¥é¿å…ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„é”å†²çªã€‚</li>
<li>åœ¨ç”Ÿäº§ç«¯å¯ä»¥ä½¿ç”¨ä¿¡å·é‡æ¥å°½é‡çš„é™ä½ç”Ÿäº§è€…ä¹‹é—´çš„é”å†²çªã€‚</li>
</ul>
<img src="https://img.gejiba.com/images/38784326cccc9a11d206065635c1a809.png" style="zoom:45%;" />
<h4 id="ç¼“å†²åŒºç±»">ç¼“å†²åŒºç±»</h4>
<ol>
<li>ç®¡ç†å­—ç¬¦ä¸²æ•°æ®çš„ç¼“å†²åŒºï¼Œæœ¬è´¨å°±æ˜¯æ•°ç»„</li>
<li>å½“å‰å†™å…¥ä½ç½®çš„æŒ‡é’ˆ</li>
<li>å½“å‰è¯»å–ä½ç½®çš„æŒ‡é’ˆ</li>
</ol>
<pre><code class="language-cpp">const size_t DEFAULT_BUFFER_SIZE = util::memory_size::m1M;
const size_t DEFAULT_THRESHOLD   = util::memory_size::m8M;
const size_t DEFAULT_INCREASE    = util::memory_size::m1M;

class buffer
{
public:
    buffer(size_t size = DEFAULT_BUFFER_SIZE);
    void push(const char* data, size_t len);
    void push(const std::string&amp; s);

    const char* pop(size_t len);

    size_t readable_size();
    size_t writable_size();

    void move_writer(size_t len);
    void move_reader(size_t len);

    void reset();
    void swap(buffer&amp; b);
    bool empty();
private:
    void ensure_size(size_t len);
private:
    std::vector&lt;char&gt; _buffer;
    size_t _reader_idx;
    size_t _writer_idx;
};
</code></pre>
<h4 id="å¼‚æ­¥å·¥ä½œå™¨ç±»">å¼‚æ­¥å·¥ä½œå™¨ç±»</h4>
<p>å¼‚æ­¥å·¥ä½œä½¿ç”¨åŒç¼“å†²åŒºè®¾è®¡ï¼Œå¤–ç•Œå°†æ•°æ®æ”¾å…¥ç”Ÿäº§ç¼“å†²åŒºï¼Œå¼‚æ­¥çº¿ç¨‹å¯¹å¤„ç†ç¼“å†²åŒºçš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚è‹¥å¤„ç†ç¼“å†²åŒºä¸ºç©ºï¼Œåˆ™ä¸¤è€…è¿›è¡Œäº¤æ¢ã€‚</p>
<p>å¼‚æ­¥å·¥ä½œå™¨ç±»çš„æˆå‘˜ï¼š</p>
<ol>
<li>åŒç¼“å†²åŒºï¼Œç”Ÿäº§å’Œæ¶ˆè´¹</li>
<li>äº’æ–¥é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</li>
<li>æ¡ä»¶å˜é‡ï¼Œç¡®å®šäº¤æ¢ç¼“å†²åŒºçš„æ—¶æœº</li>
<li>å›è°ƒå‡½æ•°ï¼Œæç¤ºå¼‚æ­¥å·¥ä½œå™¨å…·ä½“å¦‚ä½•å¤„ç†ç¼“å†²åŒºçš„æ•°æ®</li>
</ol>
<p>å¼‚æ­¥å·¥ä½œå™¨ç±»çš„æ¥å£ï¼š</p>
<ol>
<li>åœæ­¢å¼‚æ­¥å·¥ä½œå™¨</li>
<li>æ·»åŠ æ•°æ®åˆ°ç¼“å†²åŒº</li>
<li>åˆ›å»ºçº¿ç¨‹</li>
</ol>
<pre><code class="language-cpp">class async_looper
{
public:
    using ptr = std::shared_ptr&lt;async_looper&gt;;
    using handler = std::function&lt;void(buffer&amp;)&gt;;
public:
    async_looper(handler&amp; hd);
    ~async_looper() { stop(); }
    void stop();
    void push(const char* data, size_t len);
private:
    void routine();
    handler _callback; // ç¼“å†²åŒºçš„å¤„ç†å‡½æ•°
private:
    std::atomic&lt;bool&gt; _stop;
    buffer _pdr_buf; // producer buffer
    buffer _csr_buf; // consumer buffer
    std::mutex _mtx;
    std::condition_variable _pdr_cv;
    std::condition_variable _csr_cv;
    std::thread _th;
};
</code></pre>
<h4 id="å¼‚æ­¥æ—¥å¿—å™¨ç±»">å¼‚æ­¥æ—¥å¿—å™¨ç±»</h4>
<p>å¼‚æ­¥æ—¥å¿—å™¨ç»§æ‰¿è‡ªloggeræ—¥å¿—å™¨ç±»ã€‚logå‡½æ•°ä¸­ï¼Œå°†æ ¼å¼åŒ–æ•°æ®ä¼ ç»™å¼‚æ­¥å·¥ä½œå™¨ï¼Œå¼‚æ­¥å·¥ä½œå™¨å†å°†æ¶ˆæ¯æ”¾å…¥ç¼“å†²åŒºä¸­ã€‚</p>
<pre><code class="language-cpp">class async_logger : public logger
{
public:
    async_logger(const std::string&amp; name, 
                 log_level::value level, 
                 formatter::ptr&amp; fmtter, 
                 std::vector&lt;log_sink::ptr&gt;&amp; sinkers,
                 looper_type looper_type = looper_type::SAFE_MODE);
protected:
    virtual void log(const std::string&amp; data);
public:
    void looper_handler(buffer&amp; bf);
private:
    async_looper::ptr _looper; // å¼‚æ­¥å·¥ä½œå™¨
};
</code></pre>
<h3 id="37-æ—¥å¿—å™¨ç®¡ç†å™¨">3.7 æ—¥å¿—å™¨ç®¡ç†å™¨</h3>
<h4 id="è®¾è®¡-5">è®¾è®¡</h4>
<p>æ—¥å¿—å™¨ç®¡ç†ç±»ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹ç±»ç®¡ç†æ‰€æœ‰åˆ›å»ºçš„æ—¥å¿—å™¨ï¼Œä»¥è¾¾åˆ°åœ¨é¡¹ç›®ä»»æ„ä½ç½®éƒ½å¯ä»¥è·å–å•ä¾‹å¯¹è±¡çš„ç›®çš„ã€‚</p>
<p>å•ä¾‹ç®¡ç†å™¨å¯¹è±¡åˆ›å»ºæ—¶ï¼Œé»˜è®¤å…ˆåˆ›å»ºä¸€ä¸ªæ—¥å¿—å™¨ç±»ï¼Œä»…è®©æ—¥å¿—è½åœ°æ ‡å‡†è¾“å‡ºï¼Œä¾¿äºç”¨æˆ·çš„ä½¿ç”¨ã€‚</p>
<p>ç±»çš„æˆå‘˜ï¼š</p>
<ol>
<li>é»˜è®¤æ—¥å¿—å™¨</li>
<li>ç®¡ç†çš„æ—¥å¿—å™¨çš„æ•°ç»„</li>
<li>äº’æ–¥é”</li>
</ol>
<p>æä¾›çš„æ¥å£ï¼š</p>
<ol>
<li>æ·»åŠ å¹¶ç®¡ç†ä¸€ä¸ªæ—¥å¿—å™¨</li>
<li>åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŒ‡å®šåç§°çš„æ—¥å¿—å™¨</li>
<li>è·å–æŒ‡å®šåç§°çš„æ—¥å¿—å™¨</li>
<li>è·å–é»˜è®¤æ—¥å¿—å™¨</li>
</ol>
<pre><code class="language-cpp">class logger_manager
{
public:
    static logger_manager&amp; get_instance();
    void add_logger(const logger::ptr&amp; logger);
    bool has_logger(const std::string&amp; name);
    logger::ptr get_logger(const std::string&amp; name);
    logger::ptr default_logger();
private:
    logger_manager();
private:
    std::mutex _mtx;
    logger::ptr _default_logger;
    std::unordered_map&lt;std::string, logger::ptr&gt; _loggers;
};
</code></pre>
<h3 id="38-å…¨å±€æ¥å£è®¾è®¡">3.8 å…¨å±€æ¥å£è®¾è®¡</h3>
<pre><code class="language-cpp">logly::logger::ptr lg = logly::logger_manager::get_instance().default_logger();
lg-&gt;debug(__FILE__, __LINE__, &quot;%s-%d&quot;, &quot;test logger manager succ&quot;, 666);
</code></pre>
<p>ä¸Šè¿°çš„æœ€ç®€å•çš„é»˜è®¤æ—¥å¿—å™¨çš„ä½¿ç”¨æ–¹å¼è¿˜æ˜¯å¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬æä¾›å…¨å±€å‡½æ•°ï¼Œæå‡æ—¥å¿—ç³»ç»Ÿçš„ä¾¿æ·æ€§ã€‚</p>
<ol>
<li>æä¾›è·å–æŒ‡å®šæ—¥å¿—å™¨çš„å…¨å±€æ¥å£ï¼ˆé¿å…æ“ä½œå•ä¾‹å¯¹è±¡ï¼‰</li>
<li>ä½¿ç”¨å®å‡½æ•°å¯¹æ—¥å¿—æ¥å£è¿›è¡Œä»£ç†ï¼ˆä½¿ç”¨ä»£ç†æ¨¡å¼ï¼‰</li>
<li>æä¾›å®å‡½æ•°ï¼Œç›´æ¥è¿›è¡Œæ—¥å¿—çš„æ ‡å‡†è¾“å‡ºæ‰“å°ï¼ˆä¸éœ€è¦è€ƒè™‘æ—¥å¿—å™¨ï¼‰</li>
</ol>
<pre><code class="language-cpp">#define debug(fmt, ...) debug(__FILE__, __LINE__, fmt, ##__VA_ARGS__)
#define  info(fmt, ...)  info(__FILE__, __LINE__, fmt, ##__VA_ARGS__)
#define  warn(fmt, ...)  warn(__FILE__, __LINE__, fmt, ##__VA_ARGS__)
#define error(fmt, ...) error(__FILE__, __LINE__, fmt, ##__VA_ARGS__)
#define fatal(fmt, ...) fatal(__FILE__, __LINE__, fmt, ##__VA_ARGS__)

#define DEBUG(fmt, ...) logly::default_logger()-&gt;debug(fmt, ##__VA_ARGS__)
#define  INFO(fmt, ...) logly::default_logger()-&gt; info(fmt, ##__VA_ARGS__)
#define  WARN(fmt, ...) logly::default_logger()-&gt; warn(fmt, ##__VA_ARGS__)
#define ERROR(fmt, ...) logly::default_logger()-&gt;error(fmt, ##__VA_ARGS__)
#define FATAL(fmt, ...) logly::default_logger()-&gt;fatal(fmt, ##__VA_ARGS__)
</code></pre>
<pre><code class="language-cpp">DEBUG(&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
INFO (&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
WARN (&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
ERROR(&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
FATAL(&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);

logger::ptr logger = logger_manager::get_instance().get_logger(&quot;async_logger&quot;);
logger-&gt;debug(&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
logger-&gt;info (&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
logger-&gt;warn (&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
logger-&gt;error(&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
logger-&gt;fatal(&quot;%s-%d&quot;, &quot;test global interface succ&quot;, 666);
</code></pre>
<ul>
<li>ä½¿ç”¨<code>DEBUG</code>ç­‰â€œå¤§å†™â€çš„å®å‡½æ•°ï¼Œå°±æ˜¯ç›´æ¥è°ƒç”¨é»˜è®¤çš„æ—¥å¿—å™¨è¿›è¡Œæ—¥å¿—çš„æ ‡å‡†è¾“å‡ºã€‚</li>
<li><code>logger-&gt;debug</code>ç­‰æ˜¯è°ƒç”¨â€œå°å†™â€çš„å®å‡½æ•°ï¼Œå°†å‚æ•°åˆ—è¡¨æ›¿æ¢æˆå¸¦æœ‰æ–‡ä»¶åå’Œè¡Œå·çš„ã€‚å› ä¸ºå®æ˜¯å…¨å±€çš„ï¼Œæ‰€ä»¥ä¼˜å…ˆäºç±»æˆå‘˜å‡½æ•°ã€‚</li>
</ul>
<p>Â </p>
<h2 id="4-æ€§èƒ½æµ‹è¯•">4. æ€§èƒ½æµ‹è¯•</h2>
<h3 id="41-æµ‹è¯•è®¾è®¡">4.1 æµ‹è¯•è®¾è®¡</h3>
<ul>
<li>è¯„åˆ¤æ ‡å‡†ï¼šå¹³å‡æ¯ç§’èƒ½è¾“å‡ºå¤šå°‘æ¡ï¼ˆå¤šå¤§ç©ºé—´ï¼‰æ—¥å¿—åˆ°æ–‡ä»¶ã€‚</li>
<li>æ§åˆ¶å˜é‡ï¼šåŒæ­¥å¼‚æ­¥æ—¥å¿—å™¨ã€çº¿ç¨‹æ•°é‡</li>
<li>æµ‹è¯•æ–¹æ³•ï¼šè®¡ç®—æŒ‡å®šæ¡æ•°æŒ‡å®šé•¿åº¦çš„æ—¥å¿—çš„è¾“å‡ºè€—æ—¶ï¼Œå¾—å‡ºæ¯ç§’æ—¥å¿—çš„è¾“å‡ºé‡ã€‚</li>
</ul>
<h3 id="42-ä»£ç è®¾è®¡">4.2 ä»£ç è®¾è®¡</h3>
<p>æµ‹è¯•å·¥å…·æ”¯æŒï¼š</p>
<ol>
<li>æ”¯æŒæ§åˆ¶å†™æ—¥å¿—çš„çº¿ç¨‹æ•°é‡</li>
<li>æ”¯æŒæ§åˆ¶å†™æ—¥å¿—çš„æ€»æ•°é‡</li>
<li>åˆ†åˆ«å¯¹åŒæ­¥å¼‚æ­¥æ—¥å¿—å™¨è¿›è¡Œå„è‡ªçš„æ€§èƒ½æµ‹è¯•</li>
</ol>
<p>å®ç°æ–¹å¼ï¼š</p>
<p>å°è£…ä¸€ä¸ªæµ‹è¯•æ¥å£ï¼Œå‚æ•°æŒ‡å®šæ—¥å¿—å™¨ï¼Œçº¿ç¨‹æ•°é‡ã€æ—¥å¿—æ•°é‡ã€å•æ¡æ—¥å¿—å¤§å°ã€‚ï¼ˆæ—¥å¿—å¤§å°æŒ‡æœ‰æ•ˆè½½è·å¤§å°ï¼‰</p>
<p>è¾“å‡ºä¹‹å§‹å¼€å§‹è®¡æ—¶ï¼Œè¾“å‡ºå®Œæ¯•è®¡æ—¶ç»“æŸï¼ŒäºŒè€…ä¹‹å·®å°±æ˜¯æ‰€è€—æ—¶é—´ã€‚</p>
<p>æ¯ç§’è¾“å‡ºé‡ = æ—¥å¿—æ•°é‡ / æ€»è€—æ—¶</p>
<p>æ¯ç§’è¾“å‡ºå¤§å° = æ—¥å¿—æ•°é‡ * å•æ¡æ—¥å¿—å¤§å° / æ€»è€—æ—¶</p>
<blockquote>
<p>æ³¨æ„ï¼šå¼‚æ­¥æ—¥å¿—å™¨å¯åŠ¨éå®‰å…¨æ¨¡å¼ã€‚</p>
</blockquote>
<pre><code class="language-cpp">const size_t THREAD_NUM = 3;
const size_t MSG_NUM = 100 * 10000;
const size_t MSG_LEN = 50;

void bench(const std::string&amp; logger_name, size_t thread_num, size_t msg_num, size_t msg_len)
{
    logly::logger::ptr logger = logly::get_logger(logger_name);

    if (logger.get() == nullptr)
        return;
    
    printf(&quot;æµ‹è¯•å¼€å§‹ï¼Œæ—¥å¿—å…± %ld æ¡ï¼Œå•æ¡å¤§å° %ld Bytesï¼Œæ€»å¤§å° %ld KB\n\n&quot;, 
           msg_num, msg_len, msg_num * msg_len / 1024);

    std::string msg(msg_len - 1, 'a');
    size_t msg_per_th = msg_num / thread_num; // å•ä¸ªçº¿ç¨‹çš„è¾“å‡ºæ—¥å¿—æ¡æ•°

    std::vector&lt;std::thread&gt; threads;
    std::vector&lt;double&gt; cost_array(thread_num);

    for (int i = 0; i &lt; thread_num; i++)
    {
        threads.emplace_back([&amp;, i]()
            {
                auto start = std::chrono::high_resolution_clock::now();

                for (int j = 0; j &lt; msg_per_th; j++) logger-&gt;fatal(&quot;%s&quot;, msg.c_str());

                auto end = std::chrono::high_resolution_clock::now();

                std::chrono::duration&lt;double&gt; cost = end - start;
                cost_array[i] = cost.count();

                printf(&quot;çº¿ç¨‹%dï¼š\tè¾“å‡ºæ—¥å¿— %ld æ¡ï¼Œè€—æ—¶ %lf s\n&quot;, i, msg_per_th, cost_array[i]);
            }
        );
    }

    for (auto&amp; th : threads)
        th.join();

    double final_cost = cost_array[0];
    for (auto e : cost_array)
        if (final_cost &lt; e) final_cost = e;

    size_t count_per_sec = msg_num / final_cost; // æ¯ç§’è¾“å‡ºæ—¥å¿—æ•°é‡
    size_t size_per_sec = msg_num * msg_len / final_cost / 1024; // æ¯ç§’è¾“å‡ºæ—¥å¿—å¤§å° KB

    printf(&quot;\n\tæ€»è€—æ—¶ï¼š%lf s\n&quot;, final_cost);
    printf(&quot;\tæ¯ç§’è¾“å‡ºæ—¥å¿—æ•°é‡ %ld æ¡\n&quot;, count_per_sec);
    printf(&quot;\tæ¯ç§’è¾“å‡ºæ—¥å¿—å¤§å° %ld KB\n&quot;, size_per_sec);
}

void sync_bench()
{
    logly::logger_builder::ptr lbuiler(new logly::local_logger_builder);
    logly::logger_director::ptr ldirector(new logly::logger_director(lbuiler));

    ldirector-&gt;construct(logly::logger_type::SYNC_LOGGER, &quot;sync_logger&quot;, logly::log_level::DEBUG, &quot;%m%n&quot;);
    ldirector-&gt;construct_sinker&lt;logly::file_sink&gt;(&quot;./log/sync.log&quot;);
    logly::logger_manager::get_instance().add_logger(lbuiler-&gt;build());

    bench(&quot;sync_logger&quot;, 1, MSG_NUM, MSG_LEN);
}

void async_bench()
{
    logly::logger_builder::ptr lbuiler(new logly::local_logger_builder);
    logly::logger_director::ptr ldirector(new logly::logger_director(lbuiler));

    ldirector-&gt;construct(logger_type::ASYNC_LOGGER,&quot;async_logger&quot;,log_level::DEBUG, &quot;%m%n&quot;);
    ldirector-&gt;construct_sinker&lt;logly::file_sink&gt;(&quot;./log/async.log&quot;);
    ldirector-&gt;enable_unsafe_mode();
    logly::logger_manager::get_instance().add_logger(lbuiler-&gt;build());

    bench(&quot;async_logger&quot;, THREAD_NUM, MSG_NUM, MSG_LEN);
}
</code></pre>
<h3 id="43-æµ‹è¯•ç»“æœ">4.3 æµ‹è¯•ç»“æœ</h3>
<p>æµ‹è¯•ç¯å¢ƒï¼š2æ ¸2G ubuntuç³»ç»Ÿäº‘æœåŠ¡å™¨</p>
<pre><code class="language-txt">-------------- åŒæ­¥æ—¥å¿—å™¨æµ‹è¯• --------------
    
æµ‹è¯•å¼€å§‹ï¼Œæ—¥å¿—å…± 1000000æ¡ï¼Œå•æ¡å¤§å° 50 Bytesï¼Œæ€»å¤§å° 48828 KB
    
çº¿ç¨‹0ï¼š è¾“å‡ºæ—¥å¿— 333333 æ¡ï¼Œè€—æ—¶ 0.698113 s
çº¿ç¨‹2ï¼š è¾“å‡ºæ—¥å¿— 333333 æ¡ï¼Œè€—æ—¶ 0.700333 s
çº¿ç¨‹1ï¼š è¾“å‡ºæ—¥å¿— 333333 æ¡ï¼Œè€—æ—¶ 0.701003 s

    æ€»è€—æ—¶ï¼š0.701003 s
    æ¯ç§’è¾“å‡ºæ—¥å¿—æ•°é‡ 1426527 æ¡
    æ¯ç§’è¾“å‡ºæ—¥å¿—å¤§å° 69654 KB
    
    
-------------- å¼‚æ­¥æ—¥å¿—å™¨æµ‹è¯• --------------

æµ‹è¯•å¼€å§‹ï¼Œæ—¥å¿—å…± 1000000æ¡ï¼Œå•æ¡å¤§å° 50 Bytesï¼Œæ€»å¤§å° 48828 KB

çº¿ç¨‹0ï¼š è¾“å‡ºæ—¥å¿— 333333 æ¡ï¼Œè€—æ—¶ 0.664660 s
çº¿ç¨‹1ï¼š è¾“å‡ºæ—¥å¿— 333333 æ¡ï¼Œè€—æ—¶ 0.665603 s
çº¿ç¨‹2ï¼š è¾“å‡ºæ—¥å¿— 333333 æ¡ï¼Œè€—æ—¶ 0.665621 s

    æ€»è€—æ—¶ï¼š0.665621 s
    æ¯ç§’è¾“å‡ºæ—¥å¿—æ•°é‡ 1502355 æ¡
    æ¯ç§’è¾“å‡ºæ—¥å¿—å¤§å° 73357 KB
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello yourfriendyo]]></title>
        <id>https://yourfriendyo.github.io/post/hello-gridea/</id>
        <link href="https://yourfriendyo.github.io/post/hello-gridea/">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="https://gridea.dev/">Gridea ä¸»é¡µ</a><br>
<a href="https://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>Windows</strong>ï¼Œ<strong>MacOS</strong> æˆ– <strong>Linux</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>